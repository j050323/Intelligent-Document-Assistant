# 需求文档

## 简介

用户认证系统是智能文档助手系统的基础模块，负责用户的注册、登录、身份验证和权限管理。该系统采用JWT令牌认证机制，支持邮箱和用户名两种注册方式，并提供完整的账户安全保障功能。

## 术语表

- **用户系统（User System）**：管理用户账户生命周期的核心模块，包括注册、登录、信息管理和权限控制
- **JWT令牌（JWT Token）**：JSON Web Token，用于用户身份验证的加密令牌
- **验证码（Verification Code）**：用于验证用户身份的一次性代码，通过邮箱发送
- **普通用户（Regular User）**：具有基本文档管理权限的用户角色
- **管理员（Administrator）**：具有系统管理权限的用户角色，可管理所有用户和系统配置
- **BCrypt算法（BCrypt Algorithm）**：用于密码加密存储的单向哈希算法
- **登录日志（Login Log）**：记录用户登录行为的系统日志，包含时间、IP地址等信息
- **会话（Session）**：用户登录后的有效访问期间

## 需求

### 需求 1

**用户故事：** 作为新用户，我希望能够注册账户，以便使用智能文档助手系统的功能

#### 验收标准

1. WHEN 用户提交包含有效邮箱地址和密码的注册表单 THEN 用户系统 SHALL 创建新用户账户并发送验证码到该邮箱地址
2. WHEN 用户提交包含有效用户名和密码的注册表单 THEN 用户系统 SHALL 创建新用户账户并发送验证码到关联的邮箱地址
3. WHEN 用户提交的邮箱地址已被注册 THEN 用户系统 SHALL 拒绝注册请求并返回明确的错误信息
4. WHEN 用户提交的用户名已被使用 THEN 用户系统 SHALL 拒绝注册请求并返回明确的错误信息
5. WHEN 用户输入验证码 THEN 用户系统 SHALL 验证验证码的正确性并在验证成功后激活用户账户

### 需求 2

**用户故事：** 作为注册用户，我希望能够安全地登录系统，以便访问我的文档和使用系统功能

#### 验收标准

1. WHEN 用户提交有效的用户名或邮箱和正确的密码 THEN 用户系统 SHALL 生成JWT令牌并返回给用户
2. WHEN 用户提交错误的密码 THEN 用户系统 SHALL 拒绝登录请求并返回身份验证失败的错误信息
3. WHEN 用户选择"记住登录状态"选项 THEN 用户系统 SHALL 生成有效期为30天的JWT令牌
4. WHEN 用户未选择"记住登录状态"选项 THEN 用户系统 SHALL 生成有效期为24小时的JWT令牌
5. WHEN 用户成功登录 THEN 用户系统 SHALL 记录登录日志，包含登录时间、IP地址和用户标识

### 需求 3

**用户故事：** 作为登录用户，我希望能够管理我的个人信息，以便保持账户信息的准确性

#### 验收标准

1. WHEN 用户上传头像图片文件 THEN 用户系统 SHALL 验证文件格式为JPG、PNG或GIF，并将图片存储到文件系统
2. WHEN 用户上传的头像文件大小超过5MB THEN 用户系统 SHALL 拒绝上传并返回文件大小超限的错误信息
3. WHEN 用户修改个人信息字段 THEN 用户系统 SHALL 验证新信息的有效性并更新数据库中的用户记录
4. WHEN 用户修改邮箱地址 THEN 用户系统 SHALL 发送验证码到新邮箱地址并要求验证后才更新邮箱信息
5. WHEN 用户查询个人信息 THEN 用户系统 SHALL 返回该用户的所有个人信息，但不包含密码字段

### 需求 4

**用户故事：** 作为系统管理员，我希望能够控制用户权限，以便管理系统访问和功能使用

#### 验收标准

1. WHEN 用户系统创建新用户账户 THEN 用户系统 SHALL 默认分配普通用户角色
2. WHEN 管理员修改用户角色 THEN 用户系统 SHALL 更新该用户的角色信息并立即生效
3. WHEN 普通用户尝试访问管理员专属功能 THEN 用户系统 SHALL 拒绝访问并返回权限不足的错误信息
4. WHEN 管理员访问管理员专属功能 THEN 用户系统 SHALL 允许访问并执行相应操作
5. WHEN 用户的JWT令牌包含角色信息 THEN 用户系统 SHALL 在每次API请求时验证用户角色权限

### 需求 5

**用户故事：** 作为用户，我希望能够重置忘记的密码，以便在忘记密码时恢复账户访问

#### 验收标准

1. WHEN 用户请求重置密码并提供注册邮箱 THEN 用户系统 SHALL 发送包含重置链接的邮件到该邮箱地址
2. WHEN 用户点击重置链接 THEN 用户系统 SHALL 验证链接的有效性并在链接有效时显示密码重置页面
3. WHEN 重置链接创建时间超过1小时 THEN 用户系统 SHALL 拒绝该链接并提示用户重新请求密码重置
4. WHEN 用户提交新密码 THEN 用户系统 SHALL 使用BCrypt算法加密新密码并更新数据库中的密码字段
5. WHEN 密码重置成功 THEN 用户系统 SHALL 使所有该用户的现有JWT令牌失效

### 需求 6

**用户故事：** 作为系统管理员，我希望能够查看用户登录日志，以便监控系统安全和追踪异常行为

#### 验收标准

1. WHEN 用户成功登录系统 THEN 用户系统 SHALL 在system_logs表中创建登录记录，包含用户ID、操作类型、IP地址和操作时间
2. WHEN 用户登录失败 THEN 用户系统 SHALL 在system_logs表中创建失败记录，包含尝试的用户名或邮箱、IP地址和失败原因
3. WHEN 管理员查询登录日志 THEN 用户系统 SHALL 返回按时间倒序排列的登录记录列表
4. WHEN 管理员按用户ID筛选日志 THEN 用户系统 SHALL 返回该用户的所有登录记录
5. WHEN 管理员按时间范围筛选日志 THEN 用户系统 SHALL 返回指定时间范围内的所有登录记录

### 需求 7

**用户故事：** 作为系统，我需要安全地存储和验证用户密码，以便保护用户账户安全

#### 验收标准

1. WHEN 用户系统存储新密码 THEN 用户系统 SHALL 使用BCrypt算法对密码进行加密后存储到数据库
2. WHEN 用户系统验证密码 THEN 用户系统 SHALL 使用BCrypt算法比对用户输入的密码与数据库中存储的加密密码
3. WHEN 用户提交的密码长度少于8个字符 THEN 用户系统 SHALL 拒绝该密码并返回密码强度不足的错误信息
4. WHEN 用户提交的密码不包含字母和数字 THEN 用户系统 SHALL 拒绝该密码并返回密码复杂度不足的错误信息
5. WHEN 用户系统返回用户信息 THEN 用户系统 SHALL 确保响应中不包含密码字段或密码哈希值

### 需求 8

**用户故事：** 作为系统，我需要管理JWT令牌的生命周期，以便确保会话安全和用户体验

#### 验收标准

1. WHEN 用户系统生成JWT令牌 THEN 用户系统 SHALL 在令牌中包含用户ID、用户名、角色和过期时间信息
2. WHEN 用户系统验证JWT令牌 THEN 用户系统 SHALL 检查令牌签名的有效性和过期时间
3. WHEN JWT令牌已过期 THEN 用户系统 SHALL 拒绝该令牌并返回令牌过期的错误信息
4. WHEN JWT令牌签名无效 THEN 用户系统 SHALL 拒绝该令牌并返回身份验证失败的错误信息
5. WHEN 用户请求刷新令牌 THEN 用户系统 SHALL 验证当前令牌的有效性并生成新的JWT令牌
